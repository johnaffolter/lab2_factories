# Ultra-clean nginx configuration - strips ALL cookies and large headers
server {
    listen 8888;
    server_name localhost;

    # Maximum buffer sizes
    large_client_header_buffers 8 32k;
    client_header_buffer_size 32k;
    client_max_body_size 10M;

    # Ultra-aggressive header cleaning
    location / {
        # Strip ALL cookies
        proxy_set_header Cookie "";

        # Strip all user-agent info
        proxy_set_header User-Agent "CleanBrowser/1.0";

        # Strip referer
        proxy_set_header Referer "";

        # Strip accept headers that might be large
        proxy_set_header Accept "text/html,application/json";
        proxy_set_header Accept-Language "en-US";
        proxy_set_header Accept-Encoding "gzip";

        # Only essential headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Forward to Airflow
        proxy_pass http://host.docker.internal:8080;

        # Disable all caching and buffering
        proxy_buffering off;
        proxy_cache off;
        proxy_no_cache 1;
        proxy_cache_bypass 1;

        # Short timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 60s;

        # Hide server info
        proxy_hide_header Server;
        proxy_hide_header X-Powered-By;
    }

    # Special login handler - even more aggressive
    location /login {
        # Completely clean request
        proxy_set_header Cookie "";
        proxy_set_header User-Agent "SimpleClient/1.0";
        proxy_set_header Referer "";
        proxy_set_header Accept "text/html";
        proxy_set_header Accept-Language "en";
        proxy_set_header Accept-Encoding "identity";
        proxy_set_header Connection "close";

        proxy_pass http://host.docker.internal:8080/login;

        proxy_buffering off;
        proxy_cache off;
    }

    # API endpoints with minimal headers
    location /api/ {
        proxy_set_header Cookie "";
        proxy_set_header Content-Type "application/json";
        proxy_set_header Accept "application/json";

        proxy_pass http://host.docker.internal:8080/api/;

        proxy_buffering off;
    }

    # Health check
    location /nginx-health {
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
}